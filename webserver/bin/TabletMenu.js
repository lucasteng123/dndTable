// Generated by CoffeeScript 2.3.1
(function() {
  // External packages
  var OSC, TabletMenu, dataCharacters, dataMaps;

  OSC = require('osc-js');

  dataCharacters = require('../data/characters.json');

  dataMaps = require('../data/maps.json');

  TabletMenu = class TabletMenu {
    constructor() {
      var character, j, k, l, len, len1, len2, len3, m, ref, ref1, ref2, ref3;
      this.remote = "";
      this.initiatives = ["defaulty"];
      this.characters = [];
      this.npcs = [];
      this.maps = dataMaps;
      this.currentTurn = 0;
      ref = dataCharacters['PlayerCharacters'];
      for (j = 0, len = ref.length; j < len; j++) {
        character = ref[j];
        this.characters.push(character['name']);
      }
      ref1 = dataCharacters['NPC'];
      for (k = 0, len1 = ref1.length; k < len1; k++) {
        character = ref1[k];
        this.npcs.push(character['name']);
      }
      ref2 = dataCharacters['Mobs'];
      for (l = 0, len2 = ref2.length; l < len2; l++) {
        character = ref2[l];
        this.npcs.push(character['name']);
      }
      ref3 = dataCharacters['Creatures'];
      for (m = 0, len3 = ref3.length; m < len3; m++) {
        character = ref3[m];
        this.npcs.push(character['name']);
      }
    }

    bindOSC(oRecv, oSend, proj) {
      var bindRecv, i, j, k, results, self, x;
      this.oSend = oSend;
      this.proj = proj;
      self = this;
      bindRecv = function(route, func) {
        return oRecv.on(route, function(message) {
          // console.log message
          self.checkHost(message);
          func(message);
          self.drawInitiatives();
          return self.drawMaps();
        });
      };
      bindRecv('/image/change', function() {});
      bindRecv('/initiative/clear', function() {
        return self.initiatives = [];
      });
      bindRecv('/initiative/next', function() {
        if (self.currentTurn === null) {
          return self.currentTurn = 0;
        } else {
          return self.currentTurn = (self.currentTurn + 1) % self.initiatives.length;
        }
      });
// Bind commands to add a player to the initiative list
      for (i = j = 0; j <= 7; i = ++j) {
        (function(i) {
          bindRecv('/initiative/pc/' + i, function() {
            // Ignore: user clicks on blank label
            if (i >= self.characters.length) {
              return null;
            }
            // Add character name to initiatives list
            self.initiatives.push(self.characters[i]);
            return null;
          });
          return bindRecv('/initiative/npc/' + i, function() {
            // Ignore: user clicks on blank label
            if (i >= self.npcs.length) {
              return null;
            }
            // Add character name to initiatives list
            self.initiatives.push(self.npcs[i]);
            return null;
          });
        })(i);
      }

// Bind commands to add a map
      results = [];
      for (x = k = 1; k <= 7; x = ++k) {
        results.push((function(x) {
          var ii;
          ii = x - 1;
          return bindRecv('/image/change/' + ii, function() {
            // Ignore: user clicks on blank map
            if (ii >= self.maps.length) {
              return null;
            }
            return self.proj.changeImage(x, self.maps[ii]['filename']);
          });
        })(x));
      }
      return results;
    }

    checkHost(message) {
      var i, j, k, ref, ref1, results;
      if (this.remote === "") {
        this.remote = "ip-will-go-here-eventually";
        for (i = j = 0, ref = this.characters.length; (0 <= ref ? j < ref : j > ref); i = 0 <= ref ? ++j : --j) {
          this.oSend.send(new OSC.Message('/initiative/labels/pc' + i, this.characters[i]));
        }
        results = [];
        for (i = k = 0, ref1 = this.npcs.length; (0 <= ref1 ? k < ref1 : k > ref1); i = 0 <= ref1 ? ++k : --k) {
          results.push(this.oSend.send(new OSC.Message('/initiative/labels/npc' + i, this.npcs[i])));
        }
        return results;
      }
    }

    drawMaps() {
      var i, j;
      for (i = j = 0; j < 7; i = ++j) {
        // Set map label
        if (i < this.maps.length) {
          this.oSend.send(new OSC.Message('/maps/label/' + i, this.maps[i]['name']));
        } else {
          this.oSend.send(new OSC.Message('/maps/label/' + i, ""));
        }
      }
      return null;
    }

    drawInitiatives() {
      var i, j;
      for (i = j = 0; j <= 11; i = ++j) {
        // Set initiative label accordingly
        if (i < this.initiatives.length) {
          this.oSend.send(new OSC.Message('/init/turnTracker/label/' + i, this.initiatives[i]));
        } else {
          // ... or as a blank label if nothing exists here
          this.oSend.send(new OSC.Message('/init/turnTracker/label/' + i, ""));
        }
        // Set turn indicator for this label
        this.oSend.send(new OSC.Message('/init/turnTracker/' + i, this.currentTurn === i ? 0.99 : 0.01));
      }
      return null;
    }

  };

  module.exports = TabletMenu;

}).call(this);
